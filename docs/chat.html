<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chat with taylor.ai</title>
  <link rel="icon" href="visuals/favicon.png" type="image/png">
  <link
    href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,500;0,600;0,700;1,400&family=Inter:wght@300;400;500;600&display=swap"
    rel="stylesheet">

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    }

    body {
      background: #FAFAFA;
      color: #1a1a1a;
      height: 100vh;
      overflow: hidden;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      position: relative;
    }

    /* Floating Background Elements */
    .bg-element {
      position: fixed;
      border-radius: 50%;
      filter: blur(100px);
      opacity: 0.10;
      animation: float 20s infinite ease-in-out;
      pointer-events: none;
      z-index: 0;
    }

    @keyframes float {

      0%,
      100% {
        transform: translate(0, 0) scale(1);
      }

      33% {
        transform: translate(50px, -50px) scale(1.1);
      }

      66% {
        transform: translate(-50px, 50px) scale(0.9);
      }
    }

    .bg-1 {
      width: 600px;
      height: 600px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      top: -15%;
      left: -10%;
      animation-delay: 0s;
    }

    .bg-2 {
      width: 500px;
      height: 500px;
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      bottom: -15%;
      right: -10%;
      animation-delay: -7s;
    }

    .bg-3 {
      width: 350px;
      height: 350px;
      background: linear-gradient(135deg, #a78bfa 0%, #c4b5fd 100%);
      top: 40%;
      right: 30%;
      animation-delay: -14s;
    }

    /* Chat Interface Layout */
    .chat-layout {
      display: flex;
      height: 100vh;
      position: relative;
      z-index: 1;
    }

    /* Chat Area (Left Panel) */
    .chat-panel {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 2rem 2rem 7rem;
      position: relative;
    }

    /* Glass Nav Bar */
    .chat-nav {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
    }

    .chat-logo {
      font-family: 'Playfair Display', serif;
      font-size: 1.25rem;
      font-weight: 600;
      font-style: italic;
      color: #1a1a1a;
      text-decoration: none;
    }

    .logout-btn {
      padding: 0.5rem 1.25rem;
      background: rgba(255, 255, 255, 0.6);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(0, 0, 0, 0.08);
      border-radius: 50px;
      font-size: 0.8rem;
      font-weight: 500;
      color: #666;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
      display: flex;
      align-items: center;
      gap: 0.4rem;
    }

    .logout-btn:hover {
      background: rgba(255, 255, 255, 0.9);
      color: #1a1a1a;
      transform: translateY(-1px);
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.06);
    }

    /* Messages Container */
    .messages-container {
      flex: 1;
      overflow-y: auto;
      padding-right: 0.5rem;
      scroll-behavior: smooth;
    }

    .messages-container::-webkit-scrollbar {
      width: 4px;
    }

    .messages-container::-webkit-scrollbar-track {
      background: transparent;
    }

    .messages-container::-webkit-scrollbar-thumb {
      background: rgba(0, 0, 0, 0.1);
      border-radius: 4px;
    }

    /* Welcome Message */
    .welcome-container {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100%;
    }

    .welcome-text {
      text-align: center;
    }

    .welcome-text h1 {
      font-family: 'Playfair Display', serif;
      font-size: 2rem;
      font-weight: 400;
      color: #1a1a1a;
      margin-bottom: 0.5rem;
    }

    .welcome-text p {
      font-size: 0.95rem;
      color: #999;
      font-weight: 300;
    }

    /* Message Bubbles */
    .message {
      opacity: 0;
      transform: translateY(12px);
      transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
      margin-bottom: 1rem;
    }

    .message.visible {
      opacity: 1;
      transform: translateY(0);
    }

    .message-row {
      display: flex;
      margin-bottom: 0.75rem;
    }

    .message-row.user {
      justify-content: flex-end;
    }

    .message-row.bot {
      justify-content: flex-start;
    }

    .bubble {
      max-width: 340px;
      padding: 0.875rem 1.25rem;
      border-radius: 20px;
      font-size: 0.9rem;
      line-height: 1.5;
      position: relative;
    }

    .bubble.user-bubble {
      background: linear-gradient(135deg, rgba(142, 162, 255, 0.65) 0%, rgba(158, 115, 212, 0.65) 100%);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.4);
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.05);
      color: white;
      border-bottom-right-radius: 6px;
    }

    .bubble.bot-bubble {
      background: rgba(255, 255, 255, 0.7);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.4);
      color: #1a1a1a;
      border-bottom-left-radius: 6px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.04);
    }

    .bubble.error-bubble {
      background: rgba(239, 68, 68, 0.08);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(239, 68, 68, 0.15);
      color: #dc2626;
      border-bottom-left-radius: 6px;
    }

    /* Typing Indicator */
    .typing-dots {
      display: flex;
      gap: 4px;
      padding: 0.25rem 0;
    }

    .typing-dots span {
      width: 6px;
      height: 6px;
      background: #a78bfa;
      border-radius: 50%;
      animation: typing 1.4s infinite;
    }

    .typing-dots span:nth-child(2) {
      animation-delay: 0.2s;
    }

    .typing-dots span:nth-child(3) {
      animation-delay: 0.4s;
    }

    @keyframes typing {

      0%,
      60%,
      100% {
        transform: translateY(0);
        opacity: 0.4;
      }

      30% {
        transform: translateY(-6px);
        opacity: 1;
      }
    }

    /* Photo Area (Right Panel) */
    .photo-panel {
      width: 38%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 2rem;
      position: relative;
      border-left: 1px solid rgba(0, 0, 0, 0.04);
    }

    .photo-placeholder {
      text-align: center;
      color: #bbb;
    }

    .photo-placeholder svg {
      width: 56px;
      height: 56px;
      margin-bottom: 0.75rem;
      opacity: 0.4;
    }

    .photo-placeholder p {
      font-size: 0.85rem;
      font-weight: 300;
    }

    .loading-spinner {
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    .loading-spinner.active {
      display: flex;
    }

    .spinner-ring {
      width: 40px;
      height: 40px;
      border: 3px solid rgba(102, 126, 234, 0.15);
      border-top-color: #667eea;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-bottom: 1rem;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .loading-spinner p {
      font-size: 0.85rem;
      color: #999;
      font-weight: 300;
    }

    .outfits-container {
      display: none;
      width: 100%;
      overflow-y: auto;
      max-height: calc(100vh - 100px);
      padding: 0.5rem;
    }

    .outfits-container.active {
      display: block;
    }

    .outfits-container::-webkit-scrollbar {
      width: 4px;
    }

    .outfits-container::-webkit-scrollbar-thumb {
      background: rgba(0, 0, 0, 0.1);
      border-radius: 4px;
    }

    .outfit-card {
      width: 100%;
      margin-bottom: 1rem;
    }

    .outfit-card img {
      width: 100%;
      border-radius: 16px;
      margin-bottom: 0.5rem;
    }

    .outfit-shop-btn {
      display: block;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      text-align: center;
      padding: 0.625rem 1rem;
      border-radius: 50px;
      text-decoration: none;
      font-weight: 500;
      font-size: 0.8rem;
      margin-bottom: 1rem;
      transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
      letter-spacing: 0.02em;
    }

    .outfit-shop-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 8px 24px rgba(102, 126, 234, 0.3);
    }

    .user-photo {
      max-width: 100%;
      max-height: 100%;
      border-radius: 16px;
      display: none;
    }

    .user-photo.active {
      display: block;
    }

    /* Chat Input Bar */
    .input-bar-wrapper {
      position: fixed;
      bottom: 1.5rem;
      left: 50%;
      transform: translateX(-50%);
      width: 100%;
      max-width: 720px;
      padding: 0 1.5rem;
      z-index: 50;
    }

    .input-bar {
      background: rgba(255, 255, 255, 0.7);
      backdrop-filter: blur(30px) saturate(180%);
      -webkit-backdrop-filter: blur(30px) saturate(180%);
      border: 1px solid rgba(255, 255, 255, 0.4);
      border-radius: 50px;
      padding: 0.75rem 0.75rem 0.75rem 1.5rem;
      display: flex;
      align-items: center;
      box-shadow: 0 8px 40px rgba(0, 0, 0, 0.06), 0 0 0 1px rgba(0, 0, 0, 0.03);
      transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
    }

    .input-bar:focus-within {
      background: rgba(255, 255, 255, 0.85);
      box-shadow: 0 12px 48px rgba(102, 126, 234, 0.12), 0 0 0 1px rgba(102, 126, 234, 0.1);
    }

    .upload-btn {
      display: flex;
      align-items: center;
      gap: 0.35rem;
      background: none;
      border: none;
      color: #999;
      cursor: pointer;
      padding: 0.35rem 0.75rem 0.35rem 0;
      transition: color 0.3s;
      font-size: 0.8rem;
      font-weight: 400;
      border-right: 1px solid rgba(0, 0, 0, 0.06);
      margin-right: 0.75rem;
    }

    .upload-btn:hover {
      color: #667eea;
    }

    .upload-btn svg {
      width: 18px;
      height: 18px;
    }

    .chat-input {
      flex: 1;
      background: transparent;
      border: none;
      outline: none;
      font-size: 0.9rem;
      color: #1a1a1a;
      font-weight: 300;
    }

    .chat-input::placeholder {
      color: #bbb;
    }

    .send-btn {
      width: 38px;
      height: 38px;
      border-radius: 50%;
      border: none;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-left: 0.5rem;
      transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
      flex-shrink: 0;
    }

    .send-btn:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 16px rgba(102, 126, 234, 0.4);
    }

    .send-btn svg {
      width: 16px;
      height: 16px;
    }

    /* Done / View Items Button */
    .done-button {
      position: fixed;
      bottom: 5.5rem;
      right: 1.5rem;
      background: rgba(255, 255, 255, 0.7);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      color: #667eea;
      padding: 0.625rem 1.5rem;
      border-radius: 50px;
      border: 1px solid rgba(102, 126, 234, 0.2);
      cursor: pointer;
      font-size: 0.85rem;
      font-weight: 500;
      box-shadow: 0 4px 20px rgba(102, 126, 234, 0.1);
      transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
      z-index: 100;
      display: flex;
      align-items: center;
      gap: 0.4rem;
      letter-spacing: 0.02em;
    }

    .done-button:hover {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-color: transparent;
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(102, 126, 234, 0.3);
    }

    .done-button.hidden {
      display: none;
    }

    .done-button svg {
      width: 16px;
      height: 16px;
    }

    /* Modal Styles */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal-content {
      background: rgba(255, 255, 255, 0.85);
      backdrop-filter: blur(30px) saturate(180%);
      -webkit-backdrop-filter: blur(30px) saturate(180%);
      border: 1px solid rgba(255, 255, 255, 0.4);
      border-radius: 24px;
      padding: 2rem;
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.12);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid rgba(0, 0, 0, 0.06);
    }

    .modal-header h2 {
      font-family: 'Playfair Display', serif;
      font-size: 1.5rem;
      font-weight: 400;
      color: #1a1a1a;
      margin: 0;
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: #bbb;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: all 0.3s;
    }

    .modal-close:hover {
      background: rgba(0, 0, 0, 0.05);
      color: #666;
    }

    .product-item {
      display: flex;
      align-items: center;
      padding: 1rem;
      margin-bottom: 0.75rem;
      background: rgba(255, 255, 255, 0.5);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid rgba(0, 0, 0, 0.04);
      border-radius: 16px;
      transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
    }

    .product-item:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.06);
    }

    .product-thumbnail {
      width: 64px;
      height: 64px;
      object-fit: cover;
      border-radius: 12px;
      margin-right: 1rem;
    }

    .product-details {
      flex-grow: 1;
    }

    .product-brand {
      font-weight: 600;
      color: #667eea;
      margin-bottom: 0.25rem;
      font-size: 0.9rem;
    }

    .product-link-btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 0.4rem 1rem;
      border-radius: 50px;
      text-decoration: none;
      font-size: 0.75rem;
      font-weight: 500;
      transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
      display: inline-block;
      letter-spacing: 0.02em;
    }

    .product-link-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }

    /* Hidden utility */
    .hidden {
      display: none !important;
    }
  </style>
</head>

<body>
  <!-- Floating Background Elements -->
  <div class="bg-element bg-1"></div>
  <div class="bg-element bg-2"></div>
  <div class="bg-element bg-3"></div>

  <!-- Supabase Authentication Protection -->
  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

    const BACKEND_URL = 'https://stylo-ai.onrender.com';

    // Load Supabase credentials from backend env vars (not stored in the repo)
    let supabase;
    try {
      const configRes = await fetch(`${BACKEND_URL}/api/config`);
      if (!configRes.ok) throw new Error(`Config fetch failed: ${configRes.status}`);
      const { supabase_url, supabase_anon_key } = await configRes.json();
      supabase = createClient(supabase_url, supabase_anon_key);
    } catch (err) {
      console.error('Failed to load config, redirecting to login:', err);
      window.location.href = 'index.html';
      throw err;
    }

    window.userReferenceImage = null;

    // Protect this page - check session on load
    const { data: { session } } = await supabase.auth.getSession();
    if (!session) {
      console.log('No user authenticated, redirecting...');
      window.location.href = 'index.html';
    } else {
      console.log('User authenticated:', session.user.email);

      // Load user profile from DB
      try {
        const { data: userData, error } = await supabase
          .from('users')
          .select('reference_image_filename, profile_image_url')
          .eq('id', session.user.id)
          .single();

        if (error) throw error;

        if (userData?.reference_image_filename) {
          window.userReferenceImage = userData.reference_image_filename;

          const userPhoto = document.getElementById('user-photo');
          userPhoto.src = `${BACKEND_URL}/api/image/${encodeURIComponent(userData.reference_image_filename)}`;
          userPhoto.classList.add('active');
          userPhoto.classList.remove('hidden');
          document.getElementById('photo-placeholder').style.display = 'none';

          console.log('User reference image loaded:', userData.reference_image_filename);
        } else if (userData?.profile_image_url) {
          const userPhoto = document.getElementById('user-photo');
          userPhoto.src = userData.profile_image_url;
          userPhoto.classList.add('active');
          userPhoto.classList.remove('hidden');
          document.getElementById('photo-placeholder').style.display = 'none';

          console.log('User profile image loaded (no reference yet)');
        }
      } catch (error) {
        console.error('Error loading user profile:', error);
      }
    }

    // Redirect to login if session is lost
    supabase.auth.onAuthStateChange((event, session) => {
      if (!session) {
        window.location.href = 'index.html';
      }
    });

    // Logout function
    window.logout = async () => {
      const { error } = await supabase.auth.signOut();
      if (error) {
        console.error('Logout error:', error);
      } else {
        console.log('User logged out');
        window.location.href = 'index.html';
      }
    };
  </script>

  <!-- Chat Layout -->
  <div class="chat-layout">
    <!-- Chat Panel (Left) -->
    <div class="chat-panel">
      <!-- Nav -->
      <div class="chat-nav">
        <a href="index.html" class="chat-logo">taylor.ai</a>
        <button onclick="logout()" class="logout-btn">
          <span>Sign Out</span>
          <svg fill="currentColor" viewBox="0 0 24 24" width="14" height="14">
            <path
              d="M17 7l-1.41 1.41L18.17 11H8v2h10.17l-2.58 2.58L17 17l5-5zM4 5h8V3H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h8v-2H4V5z" />
          </svg>
        </button>
      </div>

      <!-- Messages -->
      <div class="messages-container" id="chat-messages">
        <div class="welcome-container">
          <div class="welcome-text">
            <h1>Ready to shop?</h1>
            <p>Ask me anything about outfits and fashion</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Photo Panel (Right) -->
    <div class="photo-panel">
      <div id="photo-placeholder" class="photo-placeholder">
        <svg fill="currentColor" viewBox="0 0 24 24">
          <path
            d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z" />
        </svg>
        <p>Your profile photo</p>
      </div>

      <!-- Loading Spinner -->
      <div id="loading-spinner" class="loading-spinner">
        <div class="spinner-ring"></div>
        <p id="loading-text">Generating your outfit...</p>
      </div>

      <!-- Outfit Results -->
      <div id="outfits-container" class="outfits-container">
        <!-- Outfit cards injected by JS -->
      </div>

      <!-- User Photo -->
      <img id="user-photo" alt="Your Photo" class="user-photo">
    </div>
  </div>

  <!-- Chat Input Bar -->
  <div class="input-bar-wrapper">
    <div class="input-bar">
      <button id="upload-photo-btn" class="upload-btn" title="Update your try-on photo">
        <svg fill="currentColor" viewBox="0 0 24 24">
          <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z" />
        </svg>
        <span>Photo</span>
      </button>
      <input type="file" id="new-photo-input" accept="image/*" class="hidden">

      <input type="text" id="chat-input" class="chat-input" placeholder="Ask taylor.ai anything...">

      <button id="submit-btn" class="send-btn">
        <svg fill="currentColor" viewBox="0 0 24 24">
          <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z" />
        </svg>
      </button>
    </div>
  </div>

  <!-- Done Button -->
  <button id="done-btn" class="done-button hidden">
    <svg fill="currentColor" viewBox="0 0 24 24">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z" />
    </svg>
    View Items
  </button>

  <!-- Products Modal -->
  <div id="products-modal" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Your Shopping List</h2>
        <button class="modal-close" onclick="closeProductsModal()">&times;</button>
      </div>
      <div id="products-list">
        <!-- Products will be inserted here -->
      </div>
    </div>
  </div>

  <script>
    const BACKEND_URL = 'https://stylo-ai.onrender.com';
    let collectedProducts = [];

    // Safely escape HTML to prevent XSS
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.appendChild(document.createTextNode(String(text)));
      return div.innerHTML;
    }

    // Helper: create a message row
    function createMessageRow(type) {
      const row = document.createElement('div');
      row.className = `message-row ${type} message`;
      return row;
    }

    function createBubble(type, text) {
      const bubble = document.createElement('div');
      bubble.className = `bubble ${type}-bubble`;
      bubble.textContent = text;
      return bubble;
    }

    // Chat functionality
    document.getElementById("submit-btn").addEventListener("click", function () {
      const input = document.getElementById("chat-input");
      const message = input.value.trim();
      if (message) sendChatMessage(message);
    });

    document.getElementById("chat-input").addEventListener("keypress", function (event) {
      if (event.key === "Enter") {
        event.preventDefault();
        const message = document.getElementById("chat-input").value.trim();
        if (message) sendChatMessage(message);
      }
    });

    async function sendChatMessage(message) {
      const chatMessages = document.getElementById("chat-messages");
      const input = document.getElementById("chat-input");
      input.value = "";

      // Clear welcome message if it exists
      const welcomeMsg = chatMessages.querySelector('.welcome-container');
      if (welcomeMsg) welcomeMsg.remove();

      // Add user message
      const userRow = createMessageRow('user');
      userRow.appendChild(createBubble('user', message));
      chatMessages.appendChild(userRow);
      setTimeout(() => userRow.classList.add("visible"), 10);
      chatMessages.scrollTop = chatMessages.scrollHeight;

      // Add typing indicator
      const typingRow = createMessageRow('bot');
      typingRow.classList.add('visible');
      const typingBubble = document.createElement('div');
      typingBubble.className = 'bubble bot-bubble';
      typingBubble.innerHTML = '<div class="typing-dots"><span></span><span></span><span></span></div>';
      typingRow.appendChild(typingBubble);
      chatMessages.appendChild(typingRow);
      chatMessages.scrollTop = chatMessages.scrollHeight;

      // Show loading spinner
      const loadingSpinner = document.getElementById("loading-spinner");
      const outfitsContainer = document.getElementById("outfits-container");
      const userPhoto = document.getElementById("user-photo");

      userPhoto.classList.remove('active');
      userPhoto.classList.add('hidden');
      outfitsContainer.classList.remove('active');
      loadingSpinner.classList.add('active');
      document.getElementById('loading-text').textContent = 'Generating your outfit...';

      try {
        console.log('Calling /api/generate-outfit...');
        console.log('Current reference image:', window.userReferenceImage);

        const requestBody = {
          prompt: message,
          max_results: 2,
          reference_image: window.userReferenceImage
        };

        console.log('Request body:', requestBody);

        const response = await fetch(`${BACKEND_URL}/api/generate-outfit`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(requestBody)
        });

        if (!response.ok) throw new Error(`API returned ${response.status}`);

        const data = await response.json();
        console.log('Backend response:', data);

        // Collect products
        if (data.products && data.products.length > 0) {
          data.products.forEach(product => {
            const exists = collectedProducts.some(p => p.product_link === product.product_link);
            if (!exists) {
              collectedProducts.push({
                brand: product.brand,
                image_url: product.image_url,
                product_link: product.product_link,
                query: message
              });
            }
          });

          console.log('Total collected products:', collectedProducts.length);

          if (collectedProducts.length > 0) {
            document.getElementById('done-btn').classList.remove('hidden');
          }
        }

        // Update reference image
        if (data.latest_image) {
          window.userReferenceImage = data.latest_image;
          console.log('Updated reference image:', window.userReferenceImage);
        }

        // Remove typing indicator
        typingRow.style.opacity = '0';
        setTimeout(() => typingRow.remove(), 300);

        // Add bot response
        const botRow = createMessageRow('bot');
        botRow.appendChild(createBubble('bot', "I've generated your outfit! Check it out on the right."));
        chatMessages.appendChild(botRow);
        setTimeout(() => botRow.classList.add("visible"), 10);
        chatMessages.scrollTop = chatMessages.scrollHeight;

        // Show generated outfits
        loadingSpinner.classList.remove('active');

        if (data.generated_images && data.generated_images.length > 0) {
          outfitsContainer.innerHTML = '';
          data.generated_images.forEach((filename, i) => {
            const product = data.products && data.products[i];

            const card = document.createElement('div');
            card.className = 'outfit-card';

            const img = document.createElement('img');
            img.src = `${BACKEND_URL}/api/image/${encodeURIComponent(filename)}`;
            img.alt = product ? `Outfit by ${product.brand}` : 'Generated outfit';
            card.appendChild(img);

            if (product && /^https?:\/\//.test(product.product_link)) {
              const shopBtn = document.createElement('a');
              shopBtn.href = product.product_link;
              shopBtn.target = '_blank';
              shopBtn.rel = 'noopener noreferrer';
              shopBtn.className = 'outfit-shop-btn';
              shopBtn.textContent = `Shop at ${product.brand}`;
              card.appendChild(shopBtn);
            }

            outfitsContainer.appendChild(card);
          });
          outfitsContainer.classList.add('active');
        } else {
          showChatError('No outfit generated');
        }

      } catch (error) {
        console.error('Error:', error);
        typingRow.style.opacity = '0';
        setTimeout(() => typingRow.remove(), 300);
        showChatError(`Error: ${error.message}`);
        loadingSpinner.classList.remove('active');
        userPhoto.classList.add('active');
        userPhoto.classList.remove('hidden');
      }
    }

    function showChatError(errorMsg) {
      const chatMessages = document.getElementById("chat-messages");
      const errorRow = createMessageRow('bot');
      errorRow.appendChild(createBubble('error', errorMsg));
      chatMessages.appendChild(errorRow);
      setTimeout(() => errorRow.classList.add("visible"), 10);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // Done button
    document.getElementById('done-btn').addEventListener('click', function () {
      showProductsModal();
    });

    function showProductsModal() {
      const modal = document.getElementById('products-modal');
      const productsList = document.getElementById('products-list');

      productsList.innerHTML = '';

      if (collectedProducts.length === 0) {
        productsList.innerHTML = '<p style="text-align: center; color: #999; font-size: 0.9rem;">No products collected yet. Start chatting to find items!</p>';
      } else {
        collectedProducts.forEach((product, index) => {
          const productItem = document.createElement('div');
          productItem.className = 'product-item';

          const thumb = document.createElement('img');
          thumb.className = 'product-thumbnail';
          thumb.alt = product.brand;
          if (/^https?:\/\//.test(product.image_url)) {
            thumb.src = product.image_url;
          }

          const details = document.createElement('div');
          details.className = 'product-details';

          const brandDiv = document.createElement('div');
          brandDiv.className = 'product-brand';
          brandDiv.textContent = product.brand;

          const queryDiv = document.createElement('div');
          queryDiv.style.cssText = 'color: #999; font-size: 0.8rem; margin-bottom: 0.5rem; font-weight: 300;';
          queryDiv.textContent = `From: "${product.query}"`;

          const link = document.createElement('a');
          link.className = 'product-link-btn';
          link.target = '_blank';
          link.rel = 'noopener noreferrer';
          link.textContent = 'View Product';
          if (/^https?:\/\//.test(product.product_link)) {
            link.href = product.product_link;
          } else {
            link.href = '#';
          }

          details.appendChild(brandDiv);
          details.appendChild(queryDiv);
          details.appendChild(link);
          productItem.appendChild(thumb);
          productItem.appendChild(details);
          productsList.appendChild(productItem);
        });
      }

      modal.classList.add('active');
    }

    function closeProductsModal() {
      document.getElementById('products-modal').classList.remove('active');
    }

    // Close modal when clicking outside
    document.getElementById('products-modal').addEventListener('click', function (e) {
      if (e.target === this) closeProductsModal();
    });

    // Upload new try-on photo via + icon
    document.getElementById('upload-photo-btn').addEventListener('click', function () {
      document.getElementById('new-photo-input').click();
    });

    document.getElementById('new-photo-input').addEventListener('change', async function (e) {
      const file = e.target.files[0];
      if (!file) return;

      const chatMessages = document.getElementById('chat-messages');
      const userPhoto = document.getElementById('user-photo');
      const loadingSpinner = document.getElementById('loading-spinner');
      const outfitsContainer = document.getElementById('outfits-container');

      // Clear welcome message if present
      const welcomeMsg = chatMessages.querySelector('.welcome-container');
      if (welcomeMsg) welcomeMsg.remove();

      // Show upload message in chat
      const uploadRow = createMessageRow('user');
      uploadRow.appendChild(createBubble('user', 'Updating photo...'));
      chatMessages.appendChild(uploadRow);
      setTimeout(() => uploadRow.classList.add('visible'), 10);
      chatMessages.scrollTop = chatMessages.scrollHeight;

      // Show loading in right panel
      userPhoto.classList.remove('active');
      userPhoto.classList.add('hidden');
      outfitsContainer.classList.remove('active');
      document.getElementById('photo-placeholder').style.display = 'none';
      loadingSpinner.classList.add('active');
      document.getElementById('loading-text').textContent = 'Processing your photo...';

      try {
        const formData = new FormData();
        formData.append('file', file);

        const res = await fetch(`${BACKEND_URL}/api/generate-reference`, {
          method: 'POST',
          body: formData
        });

        if (!res.ok) throw new Error(`Upload failed: ${res.status}`);
        const data = await res.json();

        window.userReferenceImage = data.reference_image;

        // Update right panel with new photo
        loadingSpinner.classList.remove('active');
        userPhoto.src = `${BACKEND_URL}/api/image/${encodeURIComponent(data.reference_image)}`;
        userPhoto.classList.add('active');
        userPhoto.classList.remove('hidden');

        // Success message in chat
        const successRow = createMessageRow('bot');
        successRow.appendChild(createBubble('bot', 'Photo updated! Ready to try on new outfits.'));
        chatMessages.appendChild(successRow);
        setTimeout(() => successRow.classList.add('visible'), 10);
        chatMessages.scrollTop = chatMessages.scrollHeight;

      } catch (err) {
        loadingSpinner.classList.remove('active');
        document.getElementById('photo-placeholder').style.display = '';
        showChatError(`Failed to update photo: ${err.message}`);
      }

      e.target.value = '';
    });
  </script>
</body>

</html>